# Deploy AI Safety Evals to GCP
#
# This workflow deploys the Streamlit dashboard to Cloud Run
# and syncs scenarios to GCS.
#
# Triggered on push to main or manual dispatch.
#
# Required GitHub Secrets:
#   - WIF_PROVIDER: Workload Identity Federation provider
#   - WIF_SERVICE_ACCOUNT: Service account for WIF
#   - GOOGLE_API_KEY: Google API key for Gemini models
#   - DD_API_KEY: Datadog API key

name: Deploy to GCP

on:
  push:
    branches: [main]
    paths:
      - 'streamlit_app/**'
      - 'gcp-deploy/**'
      - '.github/workflows/deploy.yaml'
  workflow_dispatch:
    inputs:
      run_experiment:
        description: 'Run an experiment after deploy'
        required: false
        default: 'false'
        type: boolean
      scenario:
        description: 'Scenario to run'
        required: false
        default: 'numberguess_game'
      model:
        description: 'Model to use'
        required: false
        default: 'gemini-3-pro'

env:
  GCP_PROJECT_ID: modelproof-platform
  GCP_REGION: us-central1
  ARTIFACT_REGISTRY: us-central1-docker.pkg.dev/modelproof-platform/ai-safety-evals
  GCS_BUCKET: ai-safety-evals-artifacts

permissions:
  contents: read
  id-token: write

jobs:
  deploy-dashboard:
    name: Deploy Streamlit Dashboard
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.run_experiment != 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Build Dashboard Docker Image
        run: |
          docker build -t ${{ env.ARTIFACT_REGISTRY }}/dashboard:${{ github.sha }} \
            -t ${{ env.ARTIFACT_REGISTRY }}/dashboard:latest \
            -f streamlit_app/Dockerfile \
            .

      - name: Push Dashboard Image
        run: |
          docker push ${{ env.ARTIFACT_REGISTRY }}/dashboard:${{ github.sha }}
          docker push ${{ env.ARTIFACT_REGISTRY }}/dashboard:latest

      - name: Deploy Dashboard to Cloud Run
        run: |
          gcloud run deploy ai-safety-dashboard \
            --image=${{ env.ARTIFACT_REGISTRY }}/dashboard:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --allow-unauthenticated \
            --memory=1Gi \
            --cpu=1 \
            --timeout=300 \
            --set-env-vars="GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }},GCS_BUCKET=${{ env.GCS_BUCKET }},DD_API_KEY=${{ secrets.DD_API_KEY }},DD_SITE=ap2.datadoghq.com" \
            --quiet

      - name: Get Dashboard URL
        run: |
          DASHBOARD_URL=$(gcloud run services describe ai-safety-dashboard \
            --region=${{ env.GCP_REGION }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --format='value(status.url)')
          echo "Dashboard deployed to: $DASHBOARD_URL"

  sync-scenarios:
    name: Sync Scenarios to GCS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Create GCS bucket if not exists
        run: |
          gsutil ls gs://${{ env.GCS_BUCKET }} || \
          gsutil mb -p ${{ env.GCP_PROJECT_ID }} -l ${{ env.GCP_REGION }} gs://${{ env.GCS_BUCKET }}

      - name: Sync scenarios to GCS
        run: |
          gsutil -m rsync -r ./scenarios gs://${{ env.GCS_BUCKET }}/scenarios/

  update-secrets:
    name: Update Secret Manager
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Update Google API Key
        run: |
          if [ -n "${{ secrets.GOOGLE_API_KEY }}" ]; then
            echo "${{ secrets.GOOGLE_API_KEY }}" | \
            gcloud secrets versions add google-api-key --data-file=- --project=${{ env.GCP_PROJECT_ID }} || \
            echo "${{ secrets.GOOGLE_API_KEY }}" | \
            gcloud secrets create google-api-key --data-file=- --replication-policy=automatic --project=${{ env.GCP_PROJECT_ID }}
          else
            echo "GOOGLE_API_KEY secret not set, skipping"
          fi

      - name: Update Datadog API Key
        run: |
          if [ -n "${{ secrets.DD_API_KEY }}" ]; then
            echo "${{ secrets.DD_API_KEY }}" | \
            gcloud secrets versions add dd-api-key --data-file=- --project=${{ env.GCP_PROJECT_ID }} || \
            echo "${{ secrets.DD_API_KEY }}" | \
            gcloud secrets create dd-api-key --data-file=- --replication-policy=automatic --project=${{ env.GCP_PROJECT_ID }}
          else
            echo "DD_API_KEY secret not set, skipping"
          fi

  run-experiment:
    name: Run Experiment
    runs-on: ubuntu-latest
    needs: [sync-scenarios]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_experiment == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Trigger Cloud Build Experiment
        run: |
          EXPERIMENT_ID="${{ github.event.inputs.scenario }}_$(date +%Y%m%d_%H%M%S)_actions"

          gcloud builds submit \
            --config=gcp-deploy/cloudbuild-experiment.yaml \
            --substitutions="_SCENARIO=${{ github.event.inputs.scenario }},_MODEL=${{ github.event.inputs.model }},_REASONING=true,_EXPERIMENT_ID=$EXPERIMENT_ID" \
            --region=${{ env.GCP_REGION }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --async \
            .

          echo "Experiment submitted: $EXPERIMENT_ID"
          echo "View at: https://console.cloud.google.com/cloud-build/builds?project=${{ env.GCP_PROJECT_ID }}"
